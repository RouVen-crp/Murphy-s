 
<!DOCTYPE html>
<html onselectstart="return false">
    <head>
        <meta charset="UTF-8" />
        <title>打飞机——明日方舟版</title>
        <link rel="stylesheet" type="text/css" href="./game.css">
        <style>
            *{ margin:0; padding:0; font-family:"Microsoft yahei",serif;}
            
        </style>
    </head>
    <body>
        <audio id="mymusic" src="./music/minigame.mp3" loop></audio>
        <div id="box">
            
            <div id="level">
                <h1>能天使单核打法术大师</h1>
                <p class="button">简单</p><br><br>
                <p class="button">中等</p><br><br>
                <p class="button">困难</p><br><br>
                <p style="color: #f00"class="button">过载模式</p><br><br>
                <p id="menu_music" onclick="play()" class="button" style="width: 40%;height: 3%;"> 打开/关闭背景音乐</p><br><br>
                <p id="quitGame" onclick="quit()"class="button">结束游戏</p> 
            </div>
            <div id="map">
                <div id="BiuAll"></div>
            </div>
            <div id="score_box">
                得分：<div id="score"></div>
            </div>
            <div id="ending">
                <p class="p1">您的最终得分是：<span>0</span></p>
                <p class="p2">获得称号：<span></span></p>
                <p class="p3 button">重新开始</p><br><br>
                <p class="p4 button">返回主菜单</p>
            </div>
        </div>
 
        <script>
            // 检查是否正在播放
            var isPlaying = false; 
            function play() {
            var player = document.querySelector('#mymusic');
            if (isPlaying) {
                // 如果正在播放, 停止播放并停止读取此音乐文件
                player.pause();
                player.src = '';
                isPlaying = false; 
            } else {
                player.src = './music/minigame.mp3';
                player.play();
                isPlaying=true;
            }
            }
           
            window.requestAnimationFrame = window.requestAnimationFrame || function (fn) {return setTimeout(fn,1000/60)};
            window.cancelAnimationFrame = window.cancelAnimationFrame || clearTimeout;
 
            //全局变量
            var oBox = document.getElementById("box"),
                oScore_box = document.getElementById("score_box"),
                oScore = document.getElementById("score"),
                oRe = document.getElementById("ending"),
                oLevel = document.getElementById("level"),
                oMap = document.getElementById("map"),
                oBiuAll = document.getElementById("BiuAll"),
                allBiu = oBiuAll.children,
                allReChild = oRe.children,
                boxOffsetTop = oBox.offsetTop,
                boxOffsetLeft = oBox.offsetLeft;
                level;
                gameStatus=true;
 
            //启动
            exe();
 
            //初始选择难度界面的点击事件
            function exe(){
 
                //难度选择
                var aP = oLevel.getElementsByTagName("p");
                for (var i = 0; i < 4; i++) {
                    (function(i){
                        aP[i].onclick = function (e) {
                            e = e || window.event;
                            startGame(i , {
                                x : e.clientX - boxOffsetLeft,
                                y : e.clientY - boxOffsetTop
                            });//第一个实参为序号 ，第二个实参为存储着鼠标距离map边缘距离的json
                            level=i;
                        }
                    })(i);
                }
                
                //restart按钮
                allReChild[2].onclick = function (e) {
                    // cancelAnimationFrame(oMap.bgTimer);//停止背景滚动
                    oScore.innerHTML = 0;
                    oRe.style.display = "none";
                    oLevel.style.display = "none";
                    e = e || window.event;
                    startGame(level , {
                                x : e.clientX - boxOffsetLeft,
                                y : e.clientY - boxOffsetTop
                            });
                };

                //back_to_menu按钮
                allReChild[5].onclick = function (ev) {
                    cancelAnimationFrame(oMap.bgTimer);//停止背景滚动
                    oRe.style.display = "none";
                    oLevel.style.display = "block";
                    oScore.innerHTML = 0;
                    oMap.innerHTML = "<div id='BiuAll'></div>";
                    oBiuAll = document.getElementById("BiuAll");
                    allBiu = oBiuAll.children;
                };
            }
 
            //开始游戏
            function startGame(level , pos){
 
                clearMap(); //执行 隐藏和清理
 
                MapBg(level); //执行 Map背景相关操作
                var p = plane(level , pos); //执行 创建我军
                enemy(level , p); //执行 创建敌军
                //enemy(level , plane(level , pos));
                oBox.score = 0;//得分清零

                document.onkeydown=function(event){
                    if(event.key==' '){                    
                        var choice=confirm("按确认(空格)继续游戏\n按取消返回主菜单");
                        if(choice==true){
                        }
                        else{
                            document.onmousemove = null; //清除移动事件
                            clearInterval(oBox.biuInterval);//不再产生新子弹
                            clearInterval(oBox.enemyIntetval);//不再产生新敌军
                            cancelAnimationFrame(oMap.bgTimer);//停止背景滚动
                            oScore_box.style.display = "none";
                            oRe.style.display = "none";
                            oLevel.style.display = "block";
                            oScore.innerHTML = 0;
                            oMap.innerHTML = "<div id='BiuAll'></div>";
                            oBiuAll = document.getElementById("BiuAll");
                            allBiu = oBiuAll.children;
                        }
                    }
                }





            }
 
            //隐藏和清理
            function clearMap(){
                oScore_box.style.display = "block";
                oScore.style.display = "block";
                oLevel.style.display = "none";//隐藏关卡选择框
            }
 
            //Map背景选择与运动
            function MapBg(level) {
                oMap.style.backgroundImage = "url('./mini-game-images/background.png')";
 
                (function m(){
                    oMap.bgPosY = oMap.bgPosY || 0;
                    oMap.bgPosY +=0.5;
                    oMap.style.backgroundPositionY = oMap.bgPosY + 'px';
                    oMap.bgTimer = requestAnimationFrame(m);
                })();
            }
 
            //创建我军
            function plane(level , pos) {
                //创建我军图片
                var oImg = new Image();//document.createElement("img");
                oImg.src = "./mini-game-images/me.png";
                oImg.width = 50;
                oImg.height = 50;
                oImg.className = "plane";
                oImg.style.left = pos.x - oImg.width/2 + 'px';
                oImg.style.top = pos.y - oImg.height/2 + 'px';
                oMap.appendChild(oImg);
 
                //边界值
                var leftMin = -oImg.width/2,
                    leftMax = oMap.clientWidth - oImg.width/2,
                    topMin = 0,
                    topMax = oMap.clientHeight - oImg.height/2;
 
                //加入mousemove事件
                document.onmousemove = function (ev) {
                    ev = ev || window.event;
                    //获取飞机实时坐标，并限制边界值
                    var left = ev.clientX - boxOffsetLeft - oImg.width/2;
                    var top = ev.clientY - boxOffsetTop - oImg.height/2;
                    left = Math.max(leftMin,left);
                    left = Math.min(leftMax,left);
                    top = Math.max(topMin,top);
                    top = Math.min(topMax,top);
                    //赋值
                    oImg.style.left = left + 'px';
                    oImg.style.top = top + 'px';
                };
 
                //调用子弹函数
                fire(oImg,level);
 
                return oImg;
            }
 
            //我军子弹
            function fire(oImg , level){
                oBox.biuInterval = setInterval(function () {
                    if ( oBox.score >= 500 ){
                        createBiu(true , -1);
                        createBiu(true , 1);
                    }else{
                        createBiu();
                    }
                } , [100 , 150 , 150 , 15][level]);
 
                function createBiu(index , d){
                    //创建子弹
                    var oBiu = new Image();
                    oBiu.src = "./mini-game-images/bullet1.png";
                    oBiu.width = 20;
                    oBiu.height = 20;
                    oBiu.className = "biu";
 
                    var left = oImg.offsetLeft + oImg.width/2 - oBiu.width/2;
                    var top = oImg.offsetTop - oBiu.height + 5;
 
                    if ( index ){
                        left += oBiu.width*d
                    }
 
                    oBiu.style.left = left + "px";
                    oBiu.style.top = top + 'px';
 
 
                    oBiuAll.appendChild(oBiu);
 
                    //子弹运动
                    function m() {
                        if ( oBiu.parentNode ){
                            var top = oBiu.offsetTop - 20;
                            if ( top < -oBiu.height ){
                                oBiuAll.removeChild(oBiu);
                            }else{
                                oBiu.style.top = top + 'px';
                                oMap.moving_biu=requestAnimationFrame(m);
                            }
                        }
                    }
                    //将运动执行队列放后面，不然子弹会直接初始就在 top-50 的位置
                    setTimeout(function(){
                        requestAnimationFrame(m);
                    },50);

                    
                }
            }
 
            //创建敌军
            function enemy(level , oPlane) {
                var w = oMap.clientWidth,
                    h = oMap.clientHeight;
 
                var speed = [4,4.5,5,8][level]; //敌军下落速度
 
                var num = 1;
                oBox.enemyIntetval = setInterval(function () {
                    var index = num%30?1:0;
 
                    //生成敌军
                    var oEnemy = new Image();
                    oEnemy.index = index;
                    oEnemy.HP = [5,1][index];
                    oEnemy.speed = speed + (Math.random()*0.6 - 0.3)*speed;
                    oEnemy.speed *= index?1:0.5;
                    oEnemy.src = "./mini-game-images/enemy"+["big","small"][index]+".png";
                    oEnemy.className = "enemy";
                    oEnemy.width = [104,54][index];
                    oEnemy.height = [80,40][index];
                    oEnemy.style.left = Math.random()*w - oEnemy.width/2 + 'px';
                    oEnemy.style.top = -oEnemy.height + 'px';
                    oMap.appendChild(oEnemy);
                    num ++;
 
                    //敌军运动
                    function m(){
                        if ( oEnemy.parentNode ){
                            var top = oEnemy.offsetTop;
                            top += oEnemy.speed;
                            if ( top >= h ){
                                oBox.score -=[5,4,4,5][level]; //漏掉飞机减分
                                oScore.innerHTML = oBox.score;
                                oMap.removeChild(oEnemy);
                            }else{
                                oEnemy.style.top = top + 'px';
                                //子弹碰撞检测
                                for (var i = allBiu.length - 1 ; i >= 0; i--) {
                                    var objBiu = allBiu[i];
                                    if ( coll(oEnemy , objBiu) ){
                                        oBiuAll.removeChild(objBiu);//移除子弹
                                        oEnemy.HP --;
                                        if ( !oEnemy.HP ){
                                            oBox.score += oEnemy.index?2:20; //打掉飞机加分
                                            oScore.innerHTML = oBox.score;
                                            boom(oEnemy.offsetLeft,oEnemy.offsetTop,oEnemy.width,oEnemy.height,index?0:2);//敌军爆炸图
                                            oMap.removeChild(oEnemy);//移除敌军
                                            return;
                                        }
                                    }
                                }
                                //我军碰撞检测
                                if ( oPlane.parentNode && coll(oEnemy,oPlane) ){
                                    boom(oEnemy.offsetLeft,oEnemy.offsetTop,oEnemy.width,oEnemy.height,index?0:2);//敌军爆炸图
                                    boom(oPlane.offsetLeft,oPlane.offsetTop,oPlane.width,oPlane.height,1);//我军爆炸图
                                    oMap.removeChild(oEnemy);//移除敌军
                                    oMap.removeChild(oPlane);//移除我军
                                    GameOver();
                                    return;
                                }
                                oMap.moving_eneny=requestAnimationFrame(m);
                            }
                        }
                    }
                    requestAnimationFrame(m);
                },[350,250,200,40][level]);
            }
 
            //损毁
            function boom(l,t,w,h,i){
                var oBoom = new Image();
                oBoom.src = "./mini-game-images/"+["boom_small","boom_me","boom_big"][i]+".png";
                oBoom.className = 'boom'+["","2",""][i];
                oBoom.width = w;
                oBoom.height = h;
                oBoom.style.left = l + "px";
                oBoom.style.top = t + 'px';
                oMap.appendChild(oBoom);
                setTimeout(function(){
                    oBoom.parentNode && oMap.removeChild(oBoom);
                },[1200,2500,1200][i]);
            }
 
            //两个物体 碰撞检测
            function coll( obj1 , obj2 ){
                var T1 = obj1.offsetTop,
                    B1 = T1+obj1.clientHeight,
                    L1 = obj1.offsetLeft,
                    R1 = L1+obj1.clientWidth;
 
                var T2 = obj2.offsetTop,
                    B2 = T2+obj2.clientHeight,
                    L2 = obj2.offsetLeft,
                    R2 = L2+obj2.clientWidth;
 
                return !( B1 < T2 || R1 < L2 || T1 > B2 || L1 > R2 );
            }
 
            //游戏结束
            function GameOver(){
                document.onmousemove = null; //清除移动事件
                clearInterval(oBox.biuInterval);//不再产生新子弹
                clearInterval(oBox.enemyIntetval);//不再产生新敌军
                ending();
            }
 
            //结算+重新开始
            function ending(){
                oScore.style.display = "none";
                oScore_box.style.display = "none";
                var s = oBox.score;
                var honor;
                if(s < 0){
                    honor = "你在玩东方吗";
                }else if ( s < 50 ){
                    honor = "菜就多练练";
                }else if ( s < 100 ){
                    honor = "飞机小师";
                }else if ( s < 200 ){
                    honor = "渐入佳境";
                }else if ( s < 400 ){
                    honor = "飞机大师";
                }else {
                    honor = "独孤求败";
                }
 
                oRe.style.display = "block";
                allReChild[0].children[0].innerHTML = s;
                allReChild[1].children[0].innerHTML = honor;
            }

            function quit(){
                window.history.go(-1);
            }
 
        </script>
    </body>
</html>
 
 
 
 